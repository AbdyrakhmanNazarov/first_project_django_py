{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load custom_tags %}

{% block blocktitle %}
  {{ title }}
{% endblock %}

{% block content %}
  {% get_groups as groups %}

  <main>
    <h2>–ò—Å–ø–∞–Ω–∏—è, –ú–∞–¥—Ä–∏–¥</h2>
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ñ—É—Ç–±–æ–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞ –†–µ–∞–ª –ú–∞–¥—Ä–∏–¥!</p>

    {% for group in groups %}
      <div>{{ group }}</div>
    {% endfor %}

    <div class="content-wrapper" style="display:flex; gap:20px;">
      <!-- ========== –°–ü–ò–°–û–ö –°–¢–£–î–ï–ù–¢–û–í ========== -->
      <section class="students_container" style="flex-grow:1;">
        {% if students %}
          {% for student in students %}
            <div class="student_card">
              <div class="student_avatar">
                <a href="{% url 'custom_admin:student_detail' student.pk %}">
                  {% if student.avatar %}
                    <img src="{{ student.avatar.url }}" alt="{{ student.name }} {{ student.surname }}" />
                  {% else %}
                    –ù–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞
                  {% endif %}
                </a>
              </div>

              <div>–ò–º—è: {{ student.name|default:'‚Äî'|capital }}</div>
              <div>–§–∞–º–∏–ª–∏—è: {{ student.surname|default:'‚Äî'|upper }}</div>
              <div>–í–æ–∑—Ä–∞—Å—Ç: {{ student.age|default:'‚Äî' }}</div>
              <div>
                –î–æ–ª–∂–Ω–æ—Å—Ç—å:
                {% if student.group %}
                  {{ student.group.name }}
                {% else %}
                  –ë–µ–∑ –≥—Ä—É–ø–ø—ã
                {% endif %}
              </div>
              <div>–ë–∞–ª–∞–Ω—Å: {{ student.contract.balance|default:'0' }}</div>
              <div>–ê–∫—Ç–∏–≤–Ω—ã–π: {{ student.is_active|yesno:"–î–∞,–ù–µ—Ç" }}</div>
              <div>–î–∞—Ç–∞: {{ student.join_date|date:'Y.m.d' }}</div>

              {% if request.user.is_authenticated %}
                <form method="post" action="{% url 'users:like_student' student_id=student.id %}">
                  {% csrf_token %}
                  <button type="submit" class="like-btn">
                    ‚ù§Ô∏è {% if student.id in liked_students %} –£–±—Ä–∞—Ç—å –ª–∞–π–∫ {% else %} –õ–∞–π–∫ {% endif %}
                  </button>
                </form>

                <form method="post" action="{% url 'users:add_to_cart' student_id=student.id %}">
                  {% csrf_token %}
                  <button type="submit" class="cart-btn">
                    üõí {% if student.id in cart %} –í –∫–æ—Ä–∑–∏–Ω–µ {% else %} –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É {% endif %}
                  </button>
                </form>
              {% else %}
                <p><em>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ª–∞–π–∫–Ω—É—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É.</em></p>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p>–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
        {% endif %}
      </section>

      <!-- ========== –°–ê–ô–î–ë–ê–† ========== -->
      <aside class="sidebar" style="width:250px; flex-shrink:0;">
        <div class="auth-bar">
          {% if request.user.is_authenticated %}
            <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ request.user.username }}!</p>
            <a href="{% url 'custom_admin:student_list' %}">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a><br>
            <a href="{% url 'users:user_page' %}">–ú–æ—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a><br>
            <a href="{% url 'logout_acc' %}">–í—ã–π—Ç–∏</a>
          {% else %}
            <a href="{% url 'login_acc' %}">–í–æ–π—Ç–∏</a>
          {% endif %}
        </div>

        <div class="filter-aside">
          <h3>–§–∏–ª—å—Ç—Ä —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
          <form method="GET">
            {{ filter.form.as_p }}
            <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
          </form>
        </div>

        {% if request.user.is_authenticated %}
          <div class="user-tools" style="margin-top: 20px;">
            <h3>–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <a href="{% url 'users:cart_view' %}">üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞</a><br>
            <a href="{% url 'users:liked_students' %}">‚ù§Ô∏è –ú–æ–∏ –ª–∞–π–∫–∏</a>
          </div>
        {% endif %}
      </aside>
    </div>

    <!-- ========== –ü–ê–ì–ò–ù–ê–¶–ò–Ø ========== -->
    {% if is_paginated %}
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        {% else %}
          <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
        {% endif %}

        {% for i in paginator.page_range %}
          {% if page_obj.number == i %}
            <span class="current">{{ i }}</span>
          {% else %}
            <a href="?page={{ i }}">{{ i }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è</a>
        {% else %}
          <span>–°–ª–µ–¥—É—é—â–∞—è</span>
        {% endif %}
      </div>
    {% endif %}
  </main>
{% endblock %}
